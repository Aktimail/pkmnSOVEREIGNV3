import{_ as t,n as e,e as n,aT as a,P as s,T as i,dr as o,ds as r,dt as l,bF as m,du as d,dv as c,c as h,dw as u,bW as g}from"./shell-a9dcd804.js";import{B as p}from"./base-translator-465d1d0d.js";import"./translation-feedback-modal-client-js-dba9c632.js";import{e as T}from"./links-30dbf643.js";import"./translation-intervention-modal-677b21bf.js";import{x as b,A as C}from"./icon-d7ad820f.js";import"./chat-mobile-xpromo-client-js-342f9966.js";import"./age-gate-standalone-client-js-55e13342.js";import"./faceplate-textarea-input-9ac7fafc.js";import"./text-input-1e857ee0.js";import"./filterNullish-9ec33a16.js";import"./constants-775ffd1d.js";import"./translations-2dea4523.js";import"./app-selector-client-js-197aee07.js";import"./TinyGesture-89d9957c.js";let v=class extends p{constructor(){super(...arguments),this.mtSeoLanguage="",this.isSeoVisit=!1,this.withInterventionModal=!1,this.target="",this.isLoadingTranslations=!1,this._partialRequestController=new a(this),this.seoVisitSettled=!1,this.pubsub=new s(this),this.onPostTranslationOverride=t=>{"PDP"===t.pageType&&(t.isContextUpdateEvent||(t.isTranslationActive?this.onTranslationsEnabled():this.onTranslationsDisabled()))},this.onCommentTranslationOverride=t=>{this.onCommentTranslationToggle(t.id,t.isTranslationActive)}}get targetElement(){if(this.target){const t=document.querySelector(this.target);if(t)return t}return this}connectedCallback(){super.connectedCallback(),this.pubsub.subscribe(i.I18nPostTranslationOverride,this.onPostTranslationOverride,!1),this.pubsub.subscribe(i.I18nCommentTranslationOverride,this.onCommentTranslationOverride,!1),this.targetElement.addEventListener(o,this.handleTranslationFeedback),this.targetElement.addEventListener("faceplate-load",this.handleCommmentPartialsLoaded)}disconnectedCallback(){super.disconnectedCallback(),this.pubsub.unsubscribe(i.I18nPostTranslationOverride,this.onPostTranslationOverride),this.pubsub.unsubscribe(i.I18nCommentTranslationOverride,this.onCommentTranslationOverride),this.targetElement.removeEventListener(o,this.handleTranslationFeedback),this.targetElement.removeEventListener("faceplate-load",this.handleCommmentPartialsLoaded)}updated(t){t.has("translationContextValue")&&void 0!==this.translationContextValue.isTranslationActive&&(this.seoVisitSettled||!this.isSeoVisit?super.onUpdateTranslationContextValue(t):this.seoVisitSettled=!0)}async onCommentTranslationToggle(t,e){const n=this.getCommentMetadataById(t);if(!n||!n.isTranslatable)return;const a=this.objectTranslationCache.get(t);if(!(e?!!a?.translatedElement:!!a?.originalElement)){const n=await this.fetchComments([t],e?"translated":"original");this.storeCommentTranslationCache(n)}this.renderTranslationCache(e,t)}async onTranslationsEnabled(){const t=await this.runTranslations(!0);r(!0),l(!0,this.mtSeoLanguage),this.submitTranslationMetrics(),this.toggleObserverForComments(t.fetchedComments)}async onTranslationsDisabled(){const t=await this.runTranslations(!1);r(!1),l(!1,this.mtSeoLanguage),this.submitTranslationMetrics(),this.toggleObserverForComments(t.fetchedComments)}async runTranslations(t){const e=t??!!this.translationContextValue.isTranslationActive,n=this.getCommentsMetadata();this.storeCommentTranslationCache(n.map((t=>({id:t.id,translation:t.isTranslated?t.slot.innerHTML:void 0,original:t.isTranslated?void 0:t.slot.innerHTML}))));const a=[];this.objectTranslationCache.forEach(((t,n)=>{(e&&!t.translatedElement||!e&&!t.originalElement)&&a.push(n)}));let s=[];return a.length&&(s=await this.fetchComments(a,e?"translated":"original"),this.storeCommentTranslationCache(s||[])),this.renderTranslationCache(e),{fetchedComments:s}}getCommentMetadataById(t){const e=this.targetElement.querySelector(`shreddit-comment[thingid="${t}"]`);if(e)return this.getCommentMetadata(e)}getCommentsMetadata(){const t=this.targetElement.querySelectorAll("shreddit-comment");return Array.from(t).filter((t=>{const e=t.getAttribute("thingid"),n=null!==t.getAttribute("is-translatable"),a=t.querySelector('div[slot="comment"]');return!!e&&n&&!!a})).map((t=>this.getCommentMetadata(t)))}getCommentMetadata(t){return{id:t.getAttribute("thingid"),isTranslated:null!==t.getAttribute("is-comment-translated"),isTranslatable:null!==t.getAttribute("is-translatable"),element:t,slot:t.querySelector('div[slot="comment"]'),cache:this.objectTranslationCache.get(t.getAttribute("thingid"))}}async fetchComments(t,e){const n=new FormData;t.forEach((t=>n.append("commentIds[]",t))),n.append("includeTranslation","translated"===e?"true":"false");const a=await this.fetchRequestPartial("/svc/shreddit/translated-comment/",{method:m.Post,body:n});return a?this.parseFetchCommentResponse(a):[]}parseFetchCommentResponse(t){return t.map((t=>{const e=t.getAttribute("data-comment-id"),n=t.querySelector(`[data-translated-comment-id="${e}"]`),a=n?.querySelector(`#${e}-translated-post-rtjson-content`),s=t.querySelector(`[data-original-comment-id="${e}"]`),i=s?.querySelector(`#${e}-post-rtjson-content`),o=t=>t?`<div class="py-0 xs:mx-xs mx-2xs inline-block">${t}</div>`:void 0;return{id:e,original:o(i?.innerHTML),translation:o(a?.innerHTML)}}))}storeCommentTranslationCache(t){t.forEach((t=>{this.updateTranslationCache(t.id,{originalElement:t.original?{content:t.original}:void 0,translatedElement:t.translation?{content:t.translation}:void 0})}))}renderTranslationCache(t,e){const n=t??!!this.translationContextValue.isTranslationActive;(e?[this.getCommentMetadataById(e)]:this.getCommentsMetadata()).filter((t=>t&&t.isTranslated!==n&&(n?!!t.cache?.translatedElement:!!t.cache?.originalElement))).forEach((t=>{const e=n?t.cache.translatedElement:t.cache.originalElement;t.slot.innerHTML=e?.content||"",n?t.element.setAttribute("is-comment-translated","true"):t.element.removeAttribute("is-comment-translated")}))}handleTranslationFeedback(t){const{postId:e,commentId:n}=t.detail,a=document.querySelector("shreddit-post"),s=a?.querySelector('[slot="title"]'),i=a?.querySelector('[slot="text-body"]'),o=this.shadowRoot?.getElementById(d.ID.PDP_COMMENT_FEEDBACK_MODAL);o&&o.show?.({post:{id:T(e),title:s?.textContent?.trim(),body_text:i?.textContent?.trim(),translation_state:this.translationContextValue.isTranslationActive},comment:{id:n,post_id:T(e),translation_state:this.translationContextValue.isTranslationActive}})}toggleObserverForComments(t){t?.forEach((t=>{const e=document.querySelector(`shreddit-comment[thingid="${t.id}"]`);e&&e?.addTranslationToggledObserver?.('div[slot="comment"]')}))}submitTranslationMetrics(t){if(!this.reportMetrics)return;const e=this.targetElement.querySelectorAll("shreddit-comment"),n=this.translationContextValue?.isTranslationActive||!1,a={},s=[];e.length&&Array.from(e).filter((t=>{const e=this.getCommentMetadata(t);if(!t||!e)return;const a=e.slot?.textContent||"",i=e.cache;let o=n?"":a,r=n?a:"";i&&(o=i.originalElement?.content||o,r=i.translatedElement?.content||r),s.push({id:e.id,originalBody:o,translatedBody:r,isTranslated:e.isTranslated,isTranslatable:e.isTranslatable})})),a.scenario=t||this.metricsScenario,a.comments=c(n,s),this.dispatchEvent(h(u,a))}handleCommmentPartialsLoaded(t){"faceplate-load"===t.type&&this.translationContextValue.isTranslationActive&&"src"in t.detail&&t.detail.src.startsWith("/svc/shreddit/more-comments/")&&t.detail.src.includes("translated=1")&&(this.submitTranslationMetrics(g.LoadMore),this.pubsub.publish(i.I18nMoreCommentsPostMetrics,{}))}render(){return b` ${this.target?C:b`<div><slot></slot></div>`} ${this.withInterventionModal?b`<translation-intervention-modal mode="comment" page-type="pdp" ?is-immersive-visit="${this.isImmersiveVisit}"></translation-intervention-modal>`:C} <translation-feedback-modal id="${d.ID.PDP_COMMENT_FEEDBACK_MODAL}"></translation-feedback-modal> `}};t([e({type:String,attribute:"mt-seo-language"})],v.prototype,"mtSeoLanguage",void 0),t([e({type:Boolean,attribute:"is-seo-visit"})],v.prototype,"isSeoVisit",void 0),t([e({type:Boolean,attribute:"is-immersive-visit"})],v.prototype,"isImmersiveVisit",void 0),t([e({type:Boolean,attribute:"with-intervention-modal"})],v.prototype,"withInterventionModal",void 0),t([e({type:String})],v.prototype,"target",void 0),v=t([n("comment-translator")],v);
