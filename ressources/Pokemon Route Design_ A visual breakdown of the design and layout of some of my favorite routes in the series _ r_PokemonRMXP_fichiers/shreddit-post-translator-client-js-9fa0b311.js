import{a as t,aC as s,P as e,fi as i,T as a,h1 as r,t as n,_ as o,n as l,aB as d,g as h,l as c,L as p,aD as u,e as m,bW as v,fQ as b,h2 as T,bF as y,aq as g,h3 as P,bZ as f,du as E,h4 as A,c as C,h5 as S,h6 as I,h7 as M,h8 as V}from"./shell-a9dcd804.js";import{B as x}from"./base-translator-465d1d0d.js";import{P as D,p as B}from"./links-30dbf643.js";import"./translation-feedback-modal-client-js-dba9c632.js";import"./translation-intervention-modal-677b21bf.js";import{A as O,x as w,bx as F,I as k,c as j,s as L}from"./icon-d7ad820f.js";import{q,r as $,s as N}from"./translations-2dea4523.js";import"./banned-user-banner-client-js-fe0e5e4a.js";import"./age-gate-standalone-client-js-55e13342.js";import"./chat-mobile-xpromo-client-js-342f9966.js";import"./faceplate-textarea-input-9ac7fafc.js";import"./text-input-1e857ee0.js";import"./filterNullish-9ec33a16.js";import"./constants-775ffd1d.js";import"./app-selector-client-js-197aee07.js";import"./TinyGesture-89d9957c.js";const R={get:()=>{if(!c.isAvailable())return;const t=c.getItem(p.I18nPostTranslationBanner);return t?JSON.parse(t):void 0},set:t=>{c.isAvailable()&&c.setItem(p.I18nPostTranslationBanner,JSON.stringify(t))},update:t=>{const s=R.get()||{};R.set({...s,...t})}};let _=class extends(t(L)){constructor(){super(...arguments),this.isImmersiveVisit=!1,this.isMtSeoVisit=!1,this.translationContextValue=s,this.pubsub=new e(this),this.onPostTranslationOverride=t=>{(t.isContextUpdateEvent||"PDP"===t.pageType&&"PDP_BANNER"!==t.source)&&(this.translationOverrideActive=t.isTranslationActive)},this.getIsTranslationActive=()=>"boolean"==typeof this.translationOverrideActive?this.translationOverrideActive:i()||!!this.translationContextValue?.isTranslationActive,this.toggleTranslation=()=>{this.userHasInteracted||(this.userDisplayCount=0,R.update({userDisplayCount:this.userDisplayCount}),this.userHasInteracted=!0);const t=!this.getIsTranslationActive(),s={pageType:"PDP",id:this.postId,isTranslationActive:t,source:"PDP_BANNER"};this.trackClickEvent(),this.pubsub.publish(a.I18nPostTranslationOverride,s),this.translationOverrideActive=t},this.handleClose=()=>{this.trackDismissEvent(),this.isDismissedByUser=!0,R.update({isDismissedByUser:this.isDismissedByUser})},this.isEligibleForBanner=()=>{const t=this.variant===r.ALL_AUTOMATIC_BANNER,s=this.variant===r.ALL_MANUAL_BANNER||this.variant===r.ALL_MANUAL_BANNER_INTERVENTION;return!(!t&&!s)&&((!s||!this.isDismissedByUser)&&!(t&&this.userDisplayCount&&this.userDisplayCount>3))}}trackViewEvent(){const t=this.getIsTranslationActive();this.trackEvent(q({post:{id:this.postId},isImmersiveTranslationsActive:!!this.translationContextValue?.isTranslationActive,isPostTranslated:t,isImmersiveVisit:this.isImmersiveVisit,isMtSeoVisit:this.isMtSeoVisit}))}trackClickEvent(){this.trackEvent($({post:{id:this.postId},isImmersiveTranslationsActive:!!this.translationContextValue?.isTranslationActive,isPostTranslated:this.getIsTranslationActive(),isPostTranslatedAfterClick:!this.getIsTranslationActive(),isImmersiveVisit:this.isImmersiveVisit,isMtSeoVisit:this.isMtSeoVisit}))}trackDismissEvent(){this.trackEvent(N({post:{id:this.postId},isImmersiveTranslationsActive:!!this.translationContextValue?.isTranslationActive,isPostTranslated:this.getIsTranslationActive(),isImmersiveVisit:this.isImmersiveVisit,isMtSeoVisit:this.isMtSeoVisit}))}connectedCallback(){if(super.connectedCallback(),!this.isEligibleForBanner())return;this.trackViewEvent(),this.pubsub.subscribe(a.I18nPostTranslationOverride,this.onPostTranslationOverride,!1);const t=R.get();this.userDisplayCount=t?.userDisplayCount??0,this.isDismissedByUser=t?.isDismissedByUser??!1,this.variant===r.ALL_AUTOMATIC_BANNER&&(this.userDisplayCount+=1,R.update({userDisplayCount:this.userDisplayCount}))}disconnectedCallback(){super.disconnectedCallback(),this.pubsub.unsubscribe(a.I18nPostTranslationOverride,this.onPostTranslationOverride)}render(){if(!this.isEligibleForBanner())return O;const t=this.getIsTranslationActive();return w`<div role="banner" aria-labelledby="pdp-post-translation-banner-sr-label" data-testid="pdp-post-translation-banner-container" class="mx-md xs:mx-0 rounded-[12px] bg-neutral-background-container text-secondary-plain h-[40px] px-md flex items-center justify-between gap-sm mt-md -mb-xs"> <div class="flex items-center gap-sm"> ${F({size:k.Small,attributes:{"aria-hidden":"true"}})} <span id="pdp-post-translation-banner-sr-label" class="sr-only" aria-live="assertive"> ${t?"La publication a été traduite, la langue d’origine est disponible":"La publication n’a pas été traduite, des traductions sont disponibles"} </span> <span class="text-12" aria-hidden="true"> ${t?"Traductions actives":"Traductions disponibles"} </span> <button class="bg-transparent border-none p-0 text-primary-plain text-12 cursor-pointer" @click="${this.toggleTranslation}" data-testid="toggle-translation-button"> ${t?"Afficher l’original":"Traduire"} </button> </div> <button @click="${this.handleClose}" class="bg-transparent p-0 border-0 inline-flex items-center" data-testid="close-banner-button" aria-label="Fermer"> ${j({size:k.Small,attributes:{className:"cursor-pointer"}})} </button> </div>`}};_.styles=[n],o([l({type:String,attribute:"post-id"})],_.prototype,"postId",void 0),o([l({type:String,attribute:"variant"})],_.prototype,"variant",void 0),o([l({type:Boolean,attribute:"is-immersive-visit"})],_.prototype,"isImmersiveVisit",void 0),o([l({type:Boolean,attribute:"is-mt-seo-visit"})],_.prototype,"isMtSeoVisit",void 0),o([d({context:u,subscribe:!0}),h()],_.prototype,"translationContextValue",void 0),o([h()],_.prototype,"translationOverrideActive",void 0),o([h()],_.prototype,"userDisplayCount",void 0),o([h()],_.prototype,"userHasInteracted",void 0),o([h()],_.prototype,"isDismissedByUser",void 0),_=o([m("pdp-post-translation-banner")],_);const U="feed",z="pdp";let G=class extends x{constructor(){super(...arguments),this.avoidedSeoTranslation=!1,this.translatorType=z,this.isSeoVisit=!1,this.isImmersiveVisit=!1,this.isMtSeoVisit=!1,this.postId="",this.withInterventionModal=!1,this.postOverrides={},this.pubsub=new e(this),this.onPostTranslationOverride=t=>{t.isContextUpdateEvent||("PDP"===t.pageType&&this.translatorType===z?(this.postOverrides[t.id]=t.isTranslationActive,this.fetchAndRenderPost(t.isTranslationActive)):"FEED"===t.pageType&&this.translatorType===U&&(this.postOverrides[t.id]=t.isTranslationActive,this.fetchAndRenderFeedPost(t.id,t.isTranslationActive)))},this.onMoreCommentsPostMetrics=()=>{this.submitTranslationMetrics(v.LoadMore)},this.handleMorePostsPartialsLoaded=t=>{if("faceplate-load"!==t.type)return;if(!this.translationContextValue.isTranslationActive)return;if(!("src"in t.detail))return;const s=t.detail.src,e=s.startsWith("/svc/shreddit/feeds/"),i=s.includes("?after=")||s.includes("&after=");e&&i&&this.submitTranslationMetrics(v.Pagination)}}get targetElement(){if(this.target){const t=document.querySelector(this.target);if(t)return t;this.logError({error:`Target element not found: ${this.target}`})}return this}connectedCallback(){super.connectedCallback(),this.pubsub.subscribe(a.I18nPostTranslationOverride,this.onPostTranslationOverride,!1),this.targetElement.addEventListener(b,this.handleTranslationFeedback),this.translatorType===U&&this.targetElement.addEventListener("faceplate-load",this.handleMorePostsPartialsLoaded),this.translatorType===z&&this.pubsub.subscribe(a.I18nMoreCommentsPostMetrics,this.onMoreCommentsPostMetrics,!1)}disconnectedCallback(){this.pubsub.unsubscribe(a.I18nPostTranslationOverride,this.onPostTranslationOverride),this.targetElement.removeEventListener(b,this.handleTranslationFeedback),this.translatorType===U&&this.targetElement.removeEventListener("faceplate-load",this.handleMorePostsPartialsLoaded),this.translatorType===z&&this.pubsub.unsubscribe(a.I18nMoreCommentsPostMetrics,this.onMoreCommentsPostMetrics)}async onTranslationsEnabled(){if(this.translatorType===z){if(this.isSeoVisit&&!this.avoidedSeoTranslation)return this.avoidedSeoTranslation=!0,this.sendPostViewEventForPDP(),void this.submitTranslationMetrics();await this.fetchAndRenderPost(!0)}else await this.fetchAndRenderAllPosts(!0);this.submitTranslationMetrics()}async onTranslationsDisabled(){this.translatorType===z?(this.avoidedSeoTranslation=!0,await this.fetchAndRenderPost(!1)):await this.fetchAndRenderAllPosts(!1),this.submitTranslationMetrics()}getShredditPost(){return this.targetElement.querySelector("shreddit-post")}getAllShredditPosts(){return this.targetElement.querySelectorAll("shreddit-post")}async fetchAndRenderPost(t){let s;const e=this.getPostToFetch(t);if(e&&(s=await this.fetchPost(e,t)),s){this.saveElementsToCache(s,t);const e=this.getShredditPost(),i=e?[e]:[];this.saveDOMPostsToCache(i,t)}this.renderCacheForShredditPosts(t),this.sendPostViewEventForPDP()}async fetchAndRenderFeedPost(t,s){const e=this.targetElement.querySelector(`shreddit-post#${t}`);if(!e)return;const i=[e];if(this.isPostTranslationMissing(e,s)){const e=await this.fetchAllPosts(i,s);e&&e.length>0?this.saveElementsToCache(e,s):this.saveEmptyPostsToCache([t])}this.saveDOMPostsToCache(i,s),this.renderCacheForShredditPosts(s,[t])}async fetchAndRenderAllPosts(t){let s;const e=this.getAllPostsToFetch(t);if(e&&(s=await this.fetchAllPosts(e,t)),s){this.saveElementsToCache(s,t);const e=this.getAllShredditPosts();this.saveDOMPostsToCache(e,t)}this.renderCacheForShredditPosts(!!this.translationContextValue.isTranslationActive)}async fetchPost(t,s){if(!t)return null;const e=s?T.GetTranslation:T.GetOriginal,i=new FormData;i.append("postId",t.id),i.append("translationState",e),t.isTranslatable&&i.append("isTranslatable","true");const a=await this.fetchRequestPartial("/svc/shreddit/translated-post/",{method:y.Post,body:i});return a||this.saveEmptyPostsToCache([t.id]),a}async fetchAllPosts(t,s){const e=t?.map((t=>t.id));if(!e||0===e.length)return null;const i=new FormData;e.forEach((t=>{i.append("postIds[]",t)})),i.append("includeTranslation",s?"true":"false"),i.append("isNewFormat","true");const a=(t&&t[0])?.viewContext||D.PopularFeed,r=(t&&t[0])?.viewType||g.CardView;if(i.append("feedViewType",r),i.append("postViewContext",a),s){let s=Array.from(t);s=s.filter((t=>t.isTranslatable)),s.forEach((t=>{i.append("isTranslatableIds[]",t.id)}))}const n=await this.fetchRequestPartial("/svc/shreddit/translated-posts/",{method:y.Post,body:i});return n||this.saveEmptyPostsToCache(e),n}getPostToFetch(t){const s=this.getShredditPost();return s?this.isPostTranslationMissing(s,t)?s:null:(this.logError({error:"post not found"}),null)}getAllPostsToFetch(t){const s=this.getAllShredditPosts();if(0===s.length)return this.logError({error:"all posts not found"}),null;const e=[];return s?.forEach((s=>{this.isPostTranslationMissing(s,t)&&e.push(s)})),e}isPostTranslationMissing(t,s){if(t.isTranslatable){const e=this.objectTranslationCache.get(t.id);if(s&&!t.isPostTranslated&&!e?.translatedElement||!s&&t.isPostTranslated&&!e?.originalElement)return!0}return!1}sendPostViewEventForPDP(){const t=this.getShredditPost();t&&this.trackEvent(this,B(t,t.isPostTranslated))}saveEmptyPostsToCache(t){t.forEach((t=>{this.objectTranslationCache.set(t,{translatedElement:{},originalElement:{}})}))}saveDOMPostsToCache(t,s){t?.forEach((t=>{const e=this.objectTranslationCache.get(t.id)||{},i=s&&e.originalElement||!s&&e.translatedElement,a=s&&t.isPostTranslated||!s&&!t.isPostTranslated;if(i||a)return;const r=t.querySelector('[slot="title"]')?.textContent,n=t.querySelector('[slot="text-body"]')?.innerHTML,o=t.querySelector(`.${P}`)?.src,l=t.querySelector("zoomable-img")?.querySelector(f.IMG)?.src,d=t.querySelector(`.${P}`)?.srcset,h={};r&&(h.title=r),n&&(h.body=n),o&&(h.img=o),l&&(h.imgfullsize=l),d&&(h.imgsrcset=d),s?e.originalElement=h:e.translatedElement=h,this.objectTranslationCache.set(t.id,e)}))}renderCacheForShredditPosts(t,s){const e=(s,e)=>{const i=this.targetElement.querySelector(`shreddit-post#${e}`),a=t?s.translatedElement:s.originalElement;if(!i||!a)return;const r=i.querySelector('[slot="title"]'),n=a.title;r&&n&&(r.textContent=n);const o=i.querySelector('[slot="text-body"]'),l=o?.querySelector(`#${V(e)}`),d=a.body;l&&d&&(l.innerHTML=d);const h=i.querySelector(`.${P}`),c=i.querySelector("zoomable-img")?.querySelector(f.IMG),p=a.img,u=a.imgfullsize,m=a.imgsrcset;p&&h?.setAttribute("src",p),m&&h?.setAttribute("srcset",m),u&&c?.setAttribute("src",u),i.isPostTranslated=t};s?.length?s.forEach((t=>{const s=this.objectTranslationCache.get(t);s&&e(s,t)})):this.objectTranslationCache.forEach(e)}handleTranslationFeedback(t){const s=this.translationContextValue.isTranslationActive,e=this.translatorType===z?this.getShredditPost():this.targetElement.querySelector(`shreddit-post#${t.detail.postId}`),i=this.translatorType===z?e?.id:t.detail.postId,a=e?.querySelector('[slot="title"]'),r=e?.querySelector('[slot="text-body"]'),n=this.shadowRoot?.getElementById(E.ID.FEEDBACK_MODAL);n&&n.show?.({post:{id:i||"",title:a?.textContent?.trim(),body_text:r?.textContent?.trim(),translation_state:s}})}submitTranslationMetrics(t){this.reportMetrics&&(this.translatorType===z&&this.submitTranslationMetricsPdp(t),this.translatorType===U&&this.submitTranslationMetricsFeeds(t))}buildPostMetrics(t){if(!t)return null;const s=this.translationContextValue?.isTranslationActive||!1,e=t?this.objectTranslationCache.get(t?.id):null,i=t.querySelector('[slot="title"')?.textContent||"",a=t.querySelector('[slot="text-body"')?.textContent||"";let r=s?"":i,n=s?i:"",o=s?"":a,l=s?a:"";return e&&(r=e.originalElement?.title||r,n=e.translatedElement?.title||n,o=e.originalElement?.body||o,l=e.translatedElement?.body||l),A({postId:t.id,postType:t.postType||"",translationSetting:s,originalTitle:r,translatedTitle:n,originalBody:o,translatedBody:l,isTitleTranslated:t.isPostTranslated,isBodyTranslated:a?t.isPostBodyTranslated:t.isPostTranslated,isTranslatable:t.isTranslatable})}submitTranslationMetricsPdp(t){if(!this.reportMetrics)return;if(this.translatorType!==z)return;const s=this.targetElement.querySelector("shreddit-post");if(!s)return;const e={},i=this.buildPostMetrics(s);e.scenario=t||this.metricsScenario,e.targetLanguage=s.translationLanguage||"",e.post=i||{},this.dispatchEvent(C(S,e))}submitTranslationMetricsFeeds(t){if(!this.reportMetrics)return;if(this.translatorType!==U)return;const s=this.targetElement.querySelectorAll("shreddit-post");if(!s||0===s.length)return;const e={},i=[];let a="";s.forEach((t=>{i.push(this.buildPostMetrics(t)),a=t.translationLanguage??a})),e.scenario=t||this.metricsScenario,e.targetLanguage=a,e.posts=I(i),this.dispatchEvent(C(M,e))}render(){return w` <pdp-post-translation-banner post-id="${this.postId}" variant="${this.indicatorsVariant}" ?is-immersive-visit="${this.isImmersiveVisit}" ?is-mt-seo-visit="${this.isMtSeoVisit}"></pdp-post-translation-banner> <div><slot></slot></div> ${this.withInterventionModal?w`<translation-intervention-modal mode="post" page-type="${this.translatorType}" ?is-immersive-visit="${this.isImmersiveVisit}"></translation-intervention-modal>`:O} <translation-feedback-modal id="${E.ID.FEEDBACK_MODAL}"> </translation-feedback-modal> `}};o([l({type:String,attribute:"translator-type"})],G.prototype,"translatorType",void 0),o([l({type:Boolean,attribute:"is-seo-visit"})],G.prototype,"isSeoVisit",void 0),o([l({type:Boolean,attribute:"is-immersive-visit"})],G.prototype,"isImmersiveVisit",void 0),o([l({type:Boolean,attribute:"is-mt-seo-visit"})],G.prototype,"isMtSeoVisit",void 0),o([l({type:String,attribute:"post-id"})],G.prototype,"postId",void 0),o([l({type:Boolean,attribute:"with-intervention-modal"})],G.prototype,"withInterventionModal",void 0),o([l({type:String,attribute:"indicators-variant"})],G.prototype,"indicatorsVariant",void 0),o([l({type:String})],G.prototype,"target",void 0),o([h()],G.prototype,"postOverrides",void 0),G=o([m("shreddit-post-translator")],G);
